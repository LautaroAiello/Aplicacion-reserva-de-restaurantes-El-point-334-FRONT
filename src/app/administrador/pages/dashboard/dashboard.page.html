<div class="dashboard-container">

    <header class="dashboard-header">
      <div class="header-text">
        <h1>Panel de control administrativo</h1>
        <p class="subtitle">Gestiona tu restaurante en tiempo real</p>
      </div>

      <button mat-flat-button color="warn" (click)="cerrarSesion()">
        <mat-icon>logout</mat-icon>
        Cerrar Sesión
      </button>
    </header>

  @if (cargando()) {
    <div class="spinner-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    </div>
  } @else {

    <!-- ============================================= -->
    <!-- 1. WIDGETS (KPIs)                             -->
    <!-- ============================================= -->
    <div class="widgets-grid">
      <!-- Reservas Confirmadas -->
      <mat-card class="widget success clickable" (click)="verConfirmadas()">
        <div class="widget-content">
          <div class="value">{{ cantConfirmadas() }}</div>
          <div class="label">Reservas Confirmadas</div>
        </div>
        <mat-icon>event_available</mat-icon>
      </mat-card>

      <!-- Reservas Pendientes -->
      <mat-card class="widget warning">
        <div class="widget-content">
          <div class="value">{{ cantPendientes() }}</div>
          <div class="label">Pendientes de Aprobación</div>
        </div>
        <mat-icon>notifications_active</mat-icon>
      </mat-card>

      <!-- Mesas Ocupadas -->
      <mat-card class="widget danger">
        <div class="widget-content">
          <div class="value">{{ cantMesasOcupadas() }}</div>
          <div class="label">Mesas Ocupadas/Bloq.</div>
        </div>
        <mat-icon>table_restaurant</mat-icon>
      </mat-card>

      <!-- Mesas Libres -->
      <mat-card class="widget info">
        <div class="widget-content">
          <div class="value">{{ cantMesasLibres() }}</div>
          <div class="label">Mesas Libres</div>
        </div>
        <mat-icon>event_seat</mat-icon>
      </mat-card>
    </div>

    <!-- ============================================= -->
    <!-- 2. ACCIONES RÁPIDAS                           -->
    <!-- ============================================= -->
    <div class="actions-bar">
      <h2>Reservas Pendientes</h2>
      <button mat-raised-button color="primary" (click)="irANuevaReserva()">
        <mat-icon>add</mat-icon> Nueva Reserva Manual
      </button>
    </div>

    <!-- ============================================= -->
    <!-- 3. TABLA DE PENDIENTES                        -->
    <!-- ============================================= -->
    <mat-card class="tabla-card">
      <mat-card-content>
        @if (reservasPendientes.length > 0) {
          <table mat-table [dataSource]="reservasPendientes">
            
            <!-- Cliente -->
           <ng-container matColumnDef="cliente">
              <th mat-header-cell *matHeaderCellDef> Cliente </th>
              <td mat-cell *matCellDef="let row"> 
                
                <div class="cliente-wrapper" style="display: flex; align-items: center; gap: 5px;">
                   <!-- Icono -->
                   @if (esReservaManual(row)) {
                     <mat-icon class="tiny-icon" style="color: #4caf50;">edit_note</mat-icon>
                   } @else {
                     <mat-icon class="tiny-icon" style="color: #2196f3;">smartphone</mat-icon>
                   }

                   <!-- Nombre (Directo del DTO, sin procesamiento) -->
                   <strong>{{ row.nombreCliente }} {{ row.apellidoCliente }}</strong>
                </div>

              </td>
            </ng-container>
            <!-- Fecha -->
            <ng-container matColumnDef="fecha">
              <th mat-header-cell *matHeaderCellDef> Fecha </th>
              <td mat-cell *matCellDef="let row"> {{ row.fechaHora | date:'dd/MM/yyyy' }} </td>
            </ng-container>

            <!-- Hora -->
            <ng-container matColumnDef="hora">
              <th mat-header-cell *matHeaderCellDef> Hora </th>
              <td mat-cell *matCellDef="let row"> 
                <span class="hora-badge">{{ row.fechaHora | date:'HH:mm' }}</span> 
              </td>
            </ng-container>

            <!-- Mesa -->
            <ng-container matColumnDef="mesa">
              <th mat-header-cell *matHeaderCellDef> Mesa(s) </th>
              <td mat-cell *matCellDef="let row"> 
                {{ row.mesasIds?.length ? row.mesasIds.join(', ') : 'Sin asignar' }}
              </td>
            </ng-container>

            <!-- Pax -->
            <ng-container matColumnDef="personas">
              <th mat-header-cell *matHeaderCellDef> Pers. </th>
              <td mat-cell *matCellDef="let row"> 
                <mat-icon class="tiny-icon">group</mat-icon> {{ row.cantidadPersonas }} 
              </td>
            </ng-container>

            <!-- Acciones -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef> Acciones </th>
              <td mat-cell *matCellDef="let row">
                <button mat-icon-button color="primary" (click)="gestionarReserva(row, 'CONFIRMADA')" title="Aceptar">
                  <mat-icon>check_circle</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="gestionarReserva(row, 'RECHAZADA')" title="Rechazar">
                  <mat-icon>cancel</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        } @else {
          <div class="empty-state">
            <mat-icon>inbox</mat-icon>
            <p>No hay reservas pendientes de aprobación.</p>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- ============================================= -->
    <!-- 4. GESTIÓN (SOLO ADMIN)                       -->
    <!-- ============================================= -->
    
      <div class="admin-section">
        <h2>Administración del Local</h2>
        <div class="admin-cards">
          <!-- 1. Mesas (VISIBLE PARA TODOS: Admin y Gestor) -->
        <mat-card class="admin-card" routerLink="/admin/mesas">
          <mat-icon>grid_view</mat-icon>
          <span>Gestionar Mesas</span> <!-- (El gestor solo podrá bloquear) -->
        </mat-card>

        <!-- LO SIGUIENTE SOLO LO VE EL ADMIN -->
        @if (esAdmin()) {
          <!-- 2. Configuración -->
          <mat-card class="admin-card" routerLink="/admin/configuracion">
            <mat-icon>settings</mat-icon>
            <span>Configuración</span>
          </mat-card>
          
          <!-- 3. Menú -->
          <mat-card class="admin-card" routerLink="/admin/menu">
            <mat-icon>restaurant_menu</mat-icon>
            <span>Menú</span>
          </mat-card>
          
          <!-- 4. Equipo -->
          <mat-card class="admin-card" [routerLink]="['/admin/asignar-gestor', restauranteId]">
            <mat-icon>badge</mat-icon>
            <span>Equipo</span>
          </mat-card>
        }

        </div>
      </div>
    

  }
</div>