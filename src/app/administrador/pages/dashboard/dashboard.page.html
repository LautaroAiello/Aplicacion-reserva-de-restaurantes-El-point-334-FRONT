<div class="dashboard-container">
  
  <!-- HEADER CON SALUDO -->
  <header>
    <h1>Panel de Control</h1>
    <p class="subtitle">Gestiona tu restaurante en tiempo real</p>
  </header>

  @if (cargando()) {
    <div class="spinner-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    </div>
  } @else {

    <!-- ============================================= -->
    <!-- 1. WIDGETS (KPIs)                             -->
    <!-- ============================================= -->
    <div class="widgets-grid">
      <!-- Reservas Confirmadas -->
      <mat-card class="widget success">
        <div class="widget-content">
          <div class="value">{{ cantConfirmadas() }}</div>
          <div class="label">Reservas Confirmadas</div>
        </div>
        <mat-icon>event_available</mat-icon>
      </mat-card>

      <!-- Reservas Pendientes -->
      <mat-card class="widget warning">
        <div class="widget-content">
          <div class="value">{{ cantPendientes() }}</div>
          <div class="label">Pendientes de Aprobación</div>
        </div>
        <mat-icon>notifications_active</mat-icon>
      </mat-card>

      <!-- Mesas Ocupadas -->
      <mat-card class="widget danger">
        <div class="widget-content">
          <div class="value">{{ cantMesasOcupadas() }}</div>
          <div class="label">Mesas Ocupadas/Bloq.</div>
        </div>
        <mat-icon>table_restaurant</mat-icon>
      </mat-card>

      <!-- Mesas Libres -->
      <mat-card class="widget info">
        <div class="widget-content">
          <div class="value">{{ cantMesasLibres() }}</div>
          <div class="label">Mesas Libres</div>
        </div>
        <mat-icon>event_seat</mat-icon>
      </mat-card>
    </div>

    <!-- ============================================= -->
    <!-- 2. ACCIONES RÁPIDAS                           -->
    <!-- ============================================= -->
    <div class="actions-bar">
      <h2>Reservas Pendientes</h2>
      <button mat-raised-button color="primary" (click)="irANuevaReserva()">
        <mat-icon>add</mat-icon> Nueva Reserva Manual
      </button>
    </div>

    <!-- ============================================= -->
    <!-- 3. TABLA DE PENDIENTES                        -->
    <!-- ============================================= -->
    <mat-card class="tabla-card">
      <mat-card-content>
        @if (reservasPendientes.length > 0) {
          <table mat-table [dataSource]="reservasPendientes">
            
            <!-- Cliente -->
            <ng-container matColumnDef="cliente">
              <th mat-header-cell *matHeaderCellDef> Cliente </th>
              <td mat-cell *matCellDef="let row"> 
                
                <!-- Lógica de visualización -->
                @if (row.observaciones?.includes('[Manual]')) {
                  <!-- Es manual: Extraemos el nombre de la observación o mostramos un indicador -->
                  <div class="cliente-manual">
                    <mat-icon class="tiny-icon">person_pin</mat-icon>
                    <strong>{{ extraerNombreManual(row.observaciones) }}</strong>
                    <span class="etiqueta-manual">(Manual)</span>
                  </div>
                } @else {
                  <!-- Es app: Mostramos usuario registrado -->
                  <div class="cliente-app">
                    <strong>{{ row.nombreCliente }} {{ row.apellidoCliente }}</strong>
                  </div>
                }

              </td>
            </ng-container>

            <!-- Fecha -->
            <ng-container matColumnDef="fecha">
              <th mat-header-cell *matHeaderCellDef> Fecha </th>
              <td mat-cell *matCellDef="let row"> {{ row.fechaHora | date:'dd/MM/yyyy' }} </td>
            </ng-container>

            <!-- Hora -->
            <ng-container matColumnDef="hora">
              <th mat-header-cell *matHeaderCellDef> Hora </th>
              <td mat-cell *matCellDef="let row"> 
                <span class="hora-badge">{{ row.fechaHora | date:'HH:mm' }}</span> 
              </td>
            </ng-container>

            <!-- Mesa -->
            <ng-container matColumnDef="mesa">
              <th mat-header-cell *matHeaderCellDef> Mesa(s) </th>
              <td mat-cell *matCellDef="let row"> 
                {{ row.mesasIds?.length ? row.mesasIds.join(', ') : 'Sin asignar' }}
              </td>
            </ng-container>

            <!-- Pax -->
            <ng-container matColumnDef="personas">
              <th mat-header-cell *matHeaderCellDef> Pers. </th>
              <td mat-cell *matCellDef="let row"> 
                <mat-icon class="tiny-icon">group</mat-icon> {{ row.cantidadPersonas }} 
              </td>
            </ng-container>

            <!-- Acciones -->
            <ng-container matColumnDef="acciones">
              <th mat-header-cell *matHeaderCellDef> Acciones </th>
              <td mat-cell *matCellDef="let row">
                <button mat-icon-button color="primary" (click)="gestionarReserva(row, 'CONFIRMADA')" title="Aceptar">
                  <mat-icon>check_circle</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="gestionarReserva(row, 'RECHAZADA')" title="Rechazar">
                  <mat-icon>cancel</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        } @else {
          <div class="empty-state">
            <mat-icon>inbox</mat-icon>
            <p>No hay reservas pendientes de aprobación.</p>
          </div>
        }
      </mat-card-content>
    </mat-card>

    <!-- ============================================= -->
    <!-- 4. GESTIÓN (SOLO ADMIN)                       -->
    <!-- ============================================= -->
    @if (esAdmin()) {
      <div class="admin-section">
        <h2>Administración del Local</h2>
        <div class="admin-cards">
          <!-- Configuración -->
          <mat-card class="admin-card" routerLink="/admin/configuracion">
            <mat-icon>settings</mat-icon>
            <span>Configuración</span>
          </mat-card>
          <!-- Mesas -->
          <mat-card class="admin-card" routerLink="/admin/mesas">
            <mat-icon>grid_view</mat-icon>
            <span>Mesas</span>
          </mat-card>
          <!-- Menú -->
          <mat-card class="admin-card" routerLink="/admin/menu">
            <mat-icon>restaurant_menu</mat-icon>
            <span>Menú</span>
          </mat-card>
          <!-- Equipo -->
          <mat-card class="admin-card" [routerLink]="['/admin/asignar-gestor', restauranteId]">
            <mat-icon>badge</mat-icon>
            <span>Equipo</span>
          </mat-card>
        </div>
      </div>
    }

  }
</div>