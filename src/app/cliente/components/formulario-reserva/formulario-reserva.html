@if (estado() === 'loading') {
<div class="estado-container">
  <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
  <p>Cargando disponibilidad...</p>
</div>
} 

@else if (estado() === 'confirmada') {
<div class="estado-container confirmada">
  <div class="icon-circle"><mat-icon>check</mat-icon></div>
  <h2>Â¡Reserva Confirmada!</h2>
  <p>Te esperamos el {{ reservaForm.value.fecha | date:'dd/MM' }} a las {{ reservaForm.value.hora }} hs.</p>
  <button mat-stroked-button (click)="resetForm()">Hacer otra reserva</button>
</div>
} 

@else if (estado() === 'error') {
<div class="estado-container error">
  <mat-icon class="error-icon">error_outline</mat-icon>
  <h3>Hubo un problema</h3>
  <p>{{ errorMessage() }}</p>
  <button mat-flat-button color="primary" (click)="estado.set('disponible')">Volver</button>
</div>
} 

@else {
<form [formGroup]="reservaForm" class="reserva-form">
  
  <h3>Datos de la Reserva</h3>

  <mat-form-field appearance="outline">
    <mat-label>Fecha</mat-label>
    <input 
      matInput 
      [matDatepicker]="picker" 
      formControlName="fecha"
      (dateChange)="verificarDisponibilidad()" 
      readonly
    >
    <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
  </mat-form-field>

  <div class="form-row">
    
    <mat-form-field appearance="outline">
      <mat-label>Hora</mat-label>
      <mat-select formControlName="hora" (selectionChange)="verificarDisponibilidad()">
        @for (hora of rangoHorarios(); track hora) {
          <mat-option [value]="hora">{{ hora }}</mat-option>
        }
      </mat-select>
      @if (reservaForm.get('hora')?.hasError('required')) {
        <mat-error>Selecciona un horario</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Personas</mat-label>
      <mat-select formControlName="cantidadPersonas">
        @for (p of personas; track p) {
          <mat-option [value]="p">{{ p }} p.</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <div class="seccion-mapa">
    
    @if (!reservaForm.get('hora')?.value) {
      <p class="aviso-horario">ðŸ‘ˆ Selecciona fecha y hora para ver quÃ© mesas estÃ¡n libres</p>
    }

    <div class="mesas-grid" [class.disabled-grid]="!reservaForm.get('hora')?.value">
      
      @for (mesa of mesas(); track mesa.id) {
        @let isOcupada = mesasOcupadasIds().has(mesa.id);

        <div 
          class="mesa-item" 
          [class.selected]="mesasSeleccionadas().has(mesa.id)"
          [class.bloqueada]="mesa.bloqueada"
          [class.ocupada]="isOcupada"
          (click)="!mesa.bloqueada && !isOcupada && toggleMesa(mesa.id)"
        >
          <mat-icon>table_restaurant</mat-icon>
          <span class="mesa-nombre">{{ mesa.descripcion || 'Mesa ' + mesa.id }}</span>
          <small>Cap: {{ mesa.capacidad }}</small>
          
          @if (mesasSeleccionadas().has(mesa.id)) {
            <div class="check-badge"><mat-icon>check</mat-icon></div>
          }

          @if (isOcupada) {
            <div class="ocupada-badge">OCUPADA</div>
          }
        </div>  
      } @empty {
        <p class="no-data">Cargando mapa del restaurante...</p>
      }
    </div>
    
    <mat-error *ngIf="mesasSeleccionadas().size === 0 && reservaForm.touched" style="font-size: 0.8rem; margin-top: 5px;">
      * Debes seleccionar al menos una mesa
    </mat-error>
  </div>

  <div class="actions">
    <button 
      mat-flat-button 
      color="primary" 
      class="btn-block"
      (click)="onConfirmarReserva()"
      [disabled]="reservaForm.invalid || mesasSeleccionadas().size === 0"
    >
      Confirmar Reserva ({{ mesasSeleccionadas().size }} mesas)
    </button>
  </div>

</form>
}